<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>ndxYtConverter</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Boostrap-icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

    <!-- google-fonts Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>

<header>
    <div class="header-content">
        <i class="bi bi-arrow-down-circle" id="logo-icon"></i>
        <h5 id="header-text"> ndxYt Converter</h5>
    </div>
</header>

<!-- SECCI√ìN DE INFORMACI√ìN DEL VIDEO (OCULTA INICIALMENTE) -->
<div class="container text-center my-5" id="seccionInfoVideo" style="display: none;">
    <div class="informacion-video">
        <img src="" alt="Miniatura del video" id="thumbnail" class="img-thumbnail mb-3" style="max-width: 320px; border-radius: 10px;">
        
        <h1 id="titulo-yt" class="mb-2">T√≠tulo del video</h1>
        <p id="nombre-canal" class="text-muted mb-1">Canal</p>
        <p id="duracion-views" class="text-muted small">Duraci√≥n: --:-- ‚Ä¢ Visualizaciones: --</p>
        <hr class="w-50 mx-auto my-3">
        
        <div class="opciones mt-4">
            <button class="btn descargar-btn me-3" id="btnDescargarDirecto">
                <i class="bi bi-download me-2"></i>Descargar ahora
            </button>

            <button class="btn convertir-otro-btn" id="btnConvertirOtro">
                <i class="bi bi-arrow-repeat me-2"></i>Convertir otro video
            </button>
        </div>
    </div>
</div>


<div class="container text-center my-5" id="seccionFormulario">
    <h1 class="mb-4" id="text-centro">ndxYt Converter</h1>

    <div class="row justify-content-center mb-3">
        <div class="col-md-6 mb-1">
            <input type="text"
                   class="form-control custom-input"
                   placeholder="Pega el enlace o busca el video"
                   id="videoUrl">
        </div>

        <div class="col-md-2 mb-2">
            <select class="form-select custom-select" id="opcionesDesplegable">
                <option value="MP3">MP3</option>
                <option value="MP4">MP4</option>
            </select>
        </div>

        <!-- Calidades -->
        <div class="col-12">
            <div class="" id="calidades">
                <button class="btn quality-btn">144p</button>
                <button class="btn quality-btn">240p</button>
                <button class="btn quality-btn">360p</button>
                <button class="btn quality-btn">480p</button>
                <button class="btn quality-btn">720p<br>(HD)</button>
                <button class="btn quality-btn">1080p<br>(Full HD)</button>
                <button class="btn quality-btn">Calidad<br>M√°xima</button>
            </div>
        </div>

        <!-- Bot√≥n convertir -->
        <div class="col-12 text-center mt-3">
            <div class="button-container">
                <button class="btn convert-btn" id="btnConvertir">
                    <i class="bi bi-download me-2"></i>
                    Convertir
                </button>
            </div>
        </div>
    </div>
</div>



<!-- Instrucciones -->
        <div class="instructions text-start">
            <h2 class="mb-3" id="text-instrucciones">¬øC√≥mo usar ndx YtConverter?</h2>

            <div class="paso-paso">
                <p>Ve a YouTube y encuentra el video que deseas convertir.</p>
            
            <p>Haz clic en <strong>‚ÄúCompartir‚Äù</strong> y luego en <strong>‚ÄúCopiar enlace‚Äù</strong>.</p>
            
            <p>Pega el enlace en el campo designado.</p>

            <p>Selecciona el formato deseado (<strong>MP3 o MP4</strong>).</p> 
            <p>Si elegiste <strong>MP4</strong>, selecciona la resoluci√≥n del video.</p>

            <p>Haz clic en el bot√≥n <strong>Convertir</strong>.</p>

            <p>Descarga tu archivo cuando el proceso finalice.</p>

            <p>¬°Disfruta tu m√∫sica o video sin conexi√≥n!</p>
            </div>
            
            


        </div>

        <div class="informacion">
            <h2 class="mb-3" id="text-instrucciones">Caracter√≠sticas de Conversi√≥n MP3 y MP4</h2>
            <p>Cada archivo convertido a MP3 incluye autom√°ticamente metadatos completos, como el t√≠tulo de la canci√≥n, artista, √°lbum asignado y portada correspondiente, lo que permite una mejor organizaci√≥n en tu reproductor de m√∫sica.</p>

            <p>Adem√°s, se agregan etiquetas de informaci√≥n optimizadas para garantizar compatibilidad con la mayor√≠a de aplicaciones y dispositivos.</p> 

            <p>En el caso de MP4, el video se genera con una calidad estable y metadatos b√°sicos, asegurando una experiencia de reproducci√≥n ordenada y sin p√©rdida de informaci√≥n.</p>
        </div>

        <div class="informacion">
            <h2 class="mb-3" id="text-instrucciones">¬øQue es ndxYt Converter, que es lo que hace?</h2>
            <p> facilidad de uso, sin necesidad de instalar programas adicionales ni realizar configuraciones complicadas.</p>
            <p>Con solo pegar el enlace del video, puedes convertir tu contenido favorito en pocos pasos.</p>
        </div>

        <div class="por-que-uso">
            <h2 class="mb-3" id="text-instrucciones">¬øPor que debo usar NdxYt Converter a comparacion de otras herramietas de conversion?</h2>
            <p>Nuestro convertidor destaca por su interfaz intuitiva, opciones de selecci√≥n de formato y resoluci√≥n, y un proceso optimizado que ahorra tiempo. </p>
            <p>Es ideal para escuchar m√∫sica sin conexi√≥n, guardar clases, conferencias o contenido educativo, y disfrutar de tus videos cuando no tienes acceso a internet.</p>
        </div>
        

<footer>
    <div class="footer-text">
        <hr>
        <p><small>¬© 2025 ndxYtConverter.</small></p>
        <p><small>Este servicio no est√° afiliado con YouTube ni Google.</small></p>
    </div>
    
</footer>



</body>
</html>


<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<script>
$(document).ready(function() {
    // =============== ELEMENTOS ===============
    const $videoUrl = $('#videoUrl');
    const $opcionesDesplegable = $('#opcionesDesplegable');
    const $calidades = $('#calidades');
    const $qualityButtons = $('.quality-btn');
    const $btnConvertir = $('#btnConvertir');
    
    // Nuevos elementos para la secci√≥n de informaci√≥n
    const $seccionPrincipal = $('#seccionFormulario');
    const $seccionInfoVideo = $('#seccionInfoVideo');
    const $thumbnail = $('#thumbnail');
    const $tituloYt = $('#titulo-yt');
    const $nombreCanal = $('#nombre-canal');
    const $duracionViews = $('#duracion-views');
    const $btnDescargarDirecto = $('#btnDescargarDirecto');
    const $btnConvertirOtro = $('#btnConvertirOtro');
    
    // Variables de estado
    let calidadSeleccionada = null;
    let formatoSeleccionado = 'MP3';
    let urlActual = '';
    let videoInfo = null;
    
    // =============== INICIALIZACI√ìN ===============
    $calidades.hide();
    $seccionInfoVideo.hide();
    
    // =============== EVENTOS ===============

    // Cambio de formato
    $opcionesDesplegable.on('change', function() {
        formatoSeleccionado = $(this).val();
        
        if (formatoSeleccionado === 'MP3') {
            console.log("Selecionado MP3");
            $calidades.hide();
            $qualityButtons.removeClass('active');
            calidadSeleccionada = null;
        } else {
            
            console.log("Selecionado MP4");
            $calidades.show();
            $qualityButtons.removeClass('active');
            $qualityButtons.last().addClass('active');
            calidadSeleccionada = 5;
        }
    });
    
    // Botones de calidad
    $qualityButtons.on('click', function() {
        $qualityButtons.removeClass('active');
        $(this).addClass('active');
        calidadSeleccionada = $qualityButtons.index($(this)) + 1;
    });
    
    // =============== BOT√ìN PRINCIPAL "CONVERTIR" ===============
    $btnConvertir.on('click', function() {
        // 1. Obtener valores
        const url = $videoUrl.val().trim();
        formatoSeleccionado = $opcionesDesplegable.val();
        
        // 2. Validaciones
        if (!url) {
            mostrarAlerta('Ingresa una URL de YouTube', 'warning');
            return;
        }
        
        if (!esUrlYouTubeValida(url)) {
            mostrarAlerta('Ingresa una URL v√°lida de YouTube', 'warning');
            return;
        }
        
        if (formatoSeleccionado === 'MP4' && !calidadSeleccionada) {
            mostrarAlerta('Selecciona una calidad para MP4', 'warning');
            return;
        }
        
        // 3. Guardar URL actual
        urlActual = url;
        
        // 4. Cambiar estado del bot√≥n
        const $btn = $(this);
        const originalText = $btn.html();
        $btn.html('<span class="spinner-border spinner-border-sm" role="status"></span> Obteniendo informaci√≥n...');
        $btn.prop('disabled', true);
        
        // 5. Obtener informaci√≥n del video
        obtenerInfoVideo(url)
            .then(function(info) {
                videoInfo = info;
                
                // 6. Mostrar informaci√≥n del video
                mostrarInformacionVideo(info);
                
                // 7. Cambiar a secci√≥n de informaci√≥n
                $seccionPrincipal.hide();
                $seccionInfoVideo.show().addClass('seccion-activa');
                
                // 8. Preparar bot√≥n de descarga directa
                prepararDescargaDirecta(url, formatoSeleccionado, calidadSeleccionada);
            })
            .catch(function(error) {
                console.error('Error:', error);
                mostrarAlerta('Error al obtener informaci√≥n del video: ' + error.message, 'danger');
            })
            .finally(function() {
                $btn.html(originalText);
                $btn.prop('disabled', false);
            });
    });
    
    // =============== BOT√ìN "DESCARGAR AHORA" ===============
    $btnDescargarDirecto.on('click', function() {
        if (!urlActual) {
            mostrarAlerta('No hay URL disponible', 'warning');
            return;
        }
        
        // Obtener calidad si es MP4
        let calidad = null;
        if (formatoSeleccionado === 'MP4') {
            const $botonActivo = $('.quality-btn.active');
            if ($botonActivo.length === 0) {
                mostrarAlerta('Selecciona una calidad', 'warning');
                return;
            }
            calidad = $qualityButtons.index($botonActivo) + 1;
        }
        
        // Iniciar descarga
        iniciarDescarga(urlActual, formatoSeleccionado, calidad);
    });
    
    // =============== BOT√ìN "CONVERTIR OTRO VIDEO" ===============
    $btnConvertirOtro.on('click', function() {
        // Resetear formulario
        $videoUrl.val('');
        $opcionesDesplegable.val('MP3').trigger('change');
        
        // Mostrar secci√≥n principal
        $seccionInfoVideo.hide().removeClass('seccion-activa');
        $seccionPrincipal.show();
        
        // Enfocar en el input
        $videoUrl.focus();
    });
    
    // =============== FUNCIONES ===============
    
    // Validar URL de YouTube
    function esUrlYouTubeValida(url) {
        const patrones = [
            /^(https?:\/\/)?(www\.)?youtube\.com\/watch\?v=[\w-]{11}/,
            /^(https?:\/\/)?youtu\.be\/[\w-]{11}/,
            /^(https?:\/\/)?(www\.)?youtube\.com\/embed\/[\w-]{11}/,
            /^(https?:\/\/)?(www\.)?youtube\.com\/v\/[\w-]{11}/
        ];
        return patrones.some(patron => patron.test(url));
    }
    
    // Obtener informaci√≥n del video
    function obtenerInfoVideo(url) {
        return new Promise(function(resolve, reject) {
            const encodedUrl = encodeURIComponent(url);
            const apiUrl = `http://127.0.0.1:8000/request?urlVideo=${encodedUrl}`;
            
            $.ajax({
                url: apiUrl,
                method: 'GET',
                success: function(data) {
                    if (data.success) {
                        resolve(data);
                    } else {
                        reject(new Error('No se pudo obtener informaci√≥n del video'));
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    reject(new Error('Error de conexi√≥n: ' + textStatus));
                }
            });
        });
    }
    
    // Mostrar informaci√≥n del video
    function mostrarInformacionVideo(info) {
        // Imagen
        $thumbnail.attr('src', info.thumbnail);
        $thumbnail.attr('alt', info.titulo || 'Miniatura del video');
        
        // T√≠tulo
        $tituloYt.text(info.titulo || 'T√≠tulo no disponible');
        
        // Canal
        $nombreCanal.text(info.canal || 'Canal no disponible');
        
        // Duraci√≥n y vistas
        const duracion = formatearDuracion(info.duracion || 0);
        const vistas = formatearVistas(info.views || 0);
        $duracionViews.text(`Duraci√≥n: ${duracion} ‚Ä¢ Visualizaciones: ${vistas}`);
        
        // Actualizar bot√≥n de descarga
        const extension = formatoSeleccionado.toLowerCase();
        $btnDescargarDirecto.html(`<i class="bi bi-download me-2"></i>Descargar ${extension.toUpperCase()}`);
    }
    
    // Preparar descarga directa
    function prepararDescargaDirecta(url, formato, calidad) {
        // Actualizar evento del bot√≥n de descarga
        $btnDescargarDirecto.off('click').on('click', function() {
            iniciarDescarga(url, formato, calidad);
        });
    }



    async function iniciarDescarga(url, formato, calidad) {
    const encodedUrl = encodeURIComponent(url);
    let downloadUrl;

    if (formato === 'MP3') {
        downloadUrl = `http://127.0.0.1:8000/conversion/mp3?url=${encodedUrl}`;
    } else {
        downloadUrl = `http://127.0.0.1:8000/conversion/mp4?url=${encodedUrl}&calidad=${calidad}`;
    }

    const $btn = $btnDescargarDirecto;
    const originalText = $btn.html();

    $btn.html('<span class="spinner-border spinner-border-sm"></span> Descargando...');
    $btn.prop('disabled', true);

    try {
        const response = await fetch(downloadUrl, { method: 'GET' });

        if (!response.ok) {
            throw new Error('La calidad seleccionada no est√° disponible');

            $seccionInfoVideo.hide();
            $seccionPrincipal.show();            
        }

        // üëâ Si existe, ahora s√≠ descargar
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        mostrarAlerta(
                        'Descarga iniciada.<br><small>Por favor espera un momento‚Ä¶</small>',
                        'success'
                    );


    } catch (error) {
        mostrarAlerta(error.message, 'danger');
        // üîô Volver a la secci√≥n anterior SIN borrar la URL
        $seccionInfoVideo.hide();
        $seccionPrincipal.show();
    } finally {
        $btn.html(originalText);
        $btn.prop('disabled', false);
    }
}



    
  function mostrarAlerta(mensaje, tipo = 'danger', tiempo = 4000) {
    // Eliminar alertas previas
    $('.alert-temp').remove();

    const alertHtml = `
        <div class="alert alert-dark alert-dismissible fade show alert-temp
                    position-fixed top-0 end-0 m-3"
            style="z-index: 9999; min-width: 300px;">
            ${mensaje}
            <button type="button" class="btn-close"></button>
        </div>
    `;

    const $alerta = $(alertHtml);
    $('body').append($alerta);

    // Bot√≥n cerrar manual
    $alerta.find('.btn-close').on('click', function () {
        $alerta.fadeOut(300, () => $alerta.remove());
    });

    // Auto cerrar
    setTimeout(() => {
        $alerta.fadeOut(400, () => $alerta.remove());
    }, tiempo);
}

    
    // Formatear duraci√≥n (segundos a MM:SS)
    function formatearDuracion(segundos) {
        if (!segundos) return '--:--';
        
        const minutos = Math.floor(segundos / 60);
        const segs = segundos % 60;
        return `${minutos}:${segs.toString().padStart(2, '0')}`;
    }
    
    // Formatear vistas
    function formatearVistas(vistas) {
        if (!vistas) return '--';
        
        if (vistas >= 1000000) {
            return (vistas / 1000000).toFixed(1) + 'M';
        } else if (vistas >= 1000) {
            return (vistas / 1000).toFixed(1) + 'K';
        }
        return vistas.toString();
    }
    
    // Inicializar calidad m√°xima para MP4
    if (formatoSeleccionado === 'MP4') {
        $qualityButtons.last().addClass('active');
        calidadSeleccionada = 5;
    }
});
</script>